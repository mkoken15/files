<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìÅ FileManager Pro</title>
  <meta name="theme-color" content="#1a3c34">
  <meta name="description" content="Gestionnaire de fichiers moderne avec dossiers, photos, vid√©os">
  <link rel="manifest" href="data:application/manifest+json,{
    'name': 'FileManager Pro',
    'short_name': 'FileMgr',
    'start_url': '/',
    'display': 'standalone',
    'background_color': '#f8fafc',
    'theme_color': '#1a3c34',
    'icons': [{'src': 'data:image/svg+xml;base64,...', 'sizes': '192x192', 'type': 'image/png'}]
  }">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <style>
    :root {
      --primary: #1a3c34;
      --primary-container: #c5e8de;
      --secondary: #4d6b63;
      --secondary-container: #d1e7e2;
      --surface: #ffffff;
      --surface-variant: #e0e3dd;
      --background: #f8fafc;
      --on-primary: #ffffff;
      --on-surface: #1c1b1f;
      --on-surface-variant: #404748;
      --error: #ba1a1a;
      --success: #067d40;
      --warning: #a55c00;
      --outline: #79747e;
      --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.2);
      --border-radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Th√®me sombre */
    @media (prefers-color-scheme: dark) {
      :root {
        --surface: #1e1e1e;
        --background: #121212;
        --surface-variant: #2b2b2b;
        --primary-container: #334f47;
        --secondary-container: #354b44;
      }
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--background);
      color: var(--on-surface);
      line-height: 1.6;
      overscroll-behavior: none;
      min-height: 100vh;
    }
    
    .app-bar {
      background: var(--surface);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .app-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .app-actions {
      display: flex;
      gap: 8px;
    }
    
    .fab {
      background: var(--primary);
      color: var(--on-primary);
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: var(--transition);
    }
    
    .fab:hover { transform: scale(1.05); }
    
    .card {
      background: var(--surface);
      border-radius: var(--border-radius);
      padding: 24px;
      margin: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--surface-variant);
      transition: var(--transition);
    }
    
    .card:hover { box-shadow: var(--shadow-lg); }
    
    .input-field {
      position: relative;
      margin: 16px 0;
    }
    
    .input-field input, .input-field select {
      width: 100%;
      padding: 16px;
      border: 2px solid var(--surface-variant);
      border-radius: 12px;
      background: var(--surface);
      color: var(--on-surface);
      font-size: 1rem;
      transition: var(--transition);
    }
    
    .input-field input:focus, .input-field select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26,60,52,0.1);
    }
    
    .btn {
      background: var(--primary);
      color: var(--on-primary);
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      margin: 4px;
    }
    
    .btn:hover { background: var(--secondary); transform: translateY(-1px); }
    .btn-success { background: var(--success); }
    .btn-danger { background: var(--error); }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
    
    .folder-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      padding: 16px;
    }
    
    .folder-card {
      background: var(--surface);
      border-radius: var(--border-radius);
      padding: 24px;
      cursor: pointer;
      text-align: center;
      border: 2px solid transparent;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .folder-card:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .folder-card.active { border-color: var(--success); background: var(--primary-container); }
    
    .folder-icon { font-size: 3rem; color: var(--primary); margin-bottom: 12px; }
    .folder-name { font-weight: 600; margin-bottom: 8px; }
    .folder-count { color: var(--on-surface-variant); font-size: 0.875rem; }
    
    .file-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      padding: 16px;
    }
    
    .file-card {
      background: var(--surface);
      border-radius: var(--border-radius);
      overflow: hidden;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: var(--transition);
      aspect-ratio: 1;
      position: relative;
    }
    
    .file-card:hover { transform: scale(1.02); box-shadow: var(--shadow-lg); }
    
    .file-preview {
      width: 100%;
      height: 120px;
      background: var(--surface-variant);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .file-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .file-preview img.loaded { opacity: 1; }
    
    .file-preview video { width: 100%; height: 100%; object-fit: cover; }
    
    .file-info {
      padding: 12px;
      text-align: center;
    }
    
    .file-name { font-weight: 500; margin-bottom: 4px; font-size: 0.875rem; }
    .file-size { color: var(--on-surface-variant); font-size: 0.75rem; }
    
    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--error);
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .file-card:hover .delete-btn { opacity: 1; }
    
    .upload-area {
      border: 2px dashed var(--outline);
      border-radius: var(--border-radius);
      padding: 48px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      margin: 16px;
    }
    
    .upload-area:hover, .upload-area.dragover {
      border-color: var(--primary);
      background: var(--primary-container);
    }
    
    .upload-icon { font-size: 4rem; color: var(--primary); margin-bottom: 16px; }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal.active { display: flex; }
    
    .modal-content {
      max-width: 90vw;
      max-height: 90vh;
      position: relative;
      border-radius: var(--border-radius);
    }
    
    .modal img, .modal video {
      max-width: 100%;
      max-height: 100%;
      border-radius: var(--border-radius);
    }
    
    .modal-close {
      position: absolute;
      top: -60px;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
    }
    
    .nav-buttons {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
    }
    
    .nav-prev { left: 20px; }
    .nav-next { right: 20px; }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      transform: translateX(100%);
      transition: transform 0.3s;
      z-index: 1001;
    }
    
    .toast.show { transform: translateX(0); }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin: 16px 0;
    }
    
    .stat-card {
      background: var(--surface);
      padding: 16px;
      border-radius: var(--border-radius);
      text-align: center;
      box-shadow: var(--shadow);
    }
    
    .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--primary); }
    .stat-label { color: var(--on-surface-variant); font-size: 0.875rem; }
    
    @media (max-width: 768px) {
      .folder-grid, .file-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
      .app-bar { padding: 16px; }
      .card { margin: 8px; padding: 16px; }
    }
  </style>
</head>
<body>
  <header class="app-bar">
    <div class="app-title">
      <span class="material-icons-outlined">folder_special</span>
      FileManager Pro
    </div>
    <div class="app-actions">
      <button class="btn btn-outline" onclick="exportData()">üì• Export</button>
      <button class="btn btn-danger" onclick="resetDatabase()">üóëÔ∏è Reset</button>
      <button class="fab" onclick="showCreateFolderModal()">
        <span class="material-icons-outlined">add</span>
      </button>
    </div>
  </header>

  <main>
    <div class="stats-grid" id="statsGrid">
      <!-- Stats dynamiques -->
    </div>

    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">
        <span class="material-icons-outlined">cloud_upload</span>
      </div>
      <h3>Glissez-d√©posez vos fichiers</h3>
      <p>ou cliquez pour s√©lectionner des images et vid√©os</p>
      <input type="file" id="fileInput" multiple accept="image/*,video/*" style="display: none;">
      <select id="folderSelect" style="margin-top: 16px;">
        <option value="">S√©lectionner un dossier</option>
      </select>
    </div>

    <div class="folder-grid" id="foldersContainer"></div>
    <div class="file-grid" id="filesContainer" style="display: none;"></div>
  </main>

  <!-- Modal cr√©ation dossier -->
  <div id="createFolderModal" class="modal">
    <div style="background: var(--surface); padding: 24px; border-radius: var(--border-radius); max-width: 400px;">
      <h2>Cr√©er un dossier</h2>
      <div class="input-field">
        <input type="text" id="folderName" placeholder="Nom du dossier">
      </div>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-outline" onclick="hideCreateFolderModal()">Annuler</button>
        <button class="btn" onclick="createFolder()">Cr√©er</button>
      </div>
    </div>
  </div>

  <!-- Modal fullscreen -->
  <div id="fullscreenModal" class="modal">
    <button class="modal-close" onclick="hideFullscreen()">
      <span class="material-icons-outlined">close</span>
    </button>
    <button class="nav-buttons nav-prev" onclick="navMedia(-1)">‚Äπ</button>
    <button class="nav-buttons nav-next" onclick="navMedia(1)">‚Ä∫</button>
    <div class="modal-content" id="modalContent"></div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    class FileManagerPro {
      constructor() {
        this.db = null;
        this.DB_NAME = "FileManagerProV3";
        this.DB_VERSION = 1;
        this.currentFolder = null;
        this.currentFiles = [];
        this.currentFileIndex = -1;
        this.init();
      }

      init() {
        this.openDB();
        this.setupEventListeners();
        this.loadFolders();
        this.updateStats();
      }

      openDB() {
        const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
        
        request.onupgradeneeded = (e) => {
          this.db = e.target.result;
          const store = this.db.createObjectStore("files", { 
            keyPath: "id", 
            autoIncrement: true 
          });
          store.createIndex("folder", "folder");
          store.createIndex("name", "name");
          store.createIndex("type", "type");
          store.createIndex("timestamp", "timestamp");
        };

        request.onsuccess = () => {
          this.db = request.result;
          console.log("‚úÖ DB initialis√©e");
        };

        request.onerror = () => this.showToast("‚ùå Erreur DB", "error");
      }

      setupEventListeners() {
        const uploadArea = document.getElementById('uploadArea');
        
        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
          uploadArea.addEventListener(event, (e) => {
            e.preventDefault();
            if (event === 'dragenter' || event === 'dragover') {
              uploadArea.classList.add('dragover');
            } else {
              uploadArea.classList.remove('dragover');
              if (event === 'drop') {
                const folder = document.getElementById('folderSelect').value;
                if (folder) this.handleFiles(e.dataTransfer.files, folder);
              }
            }
          });
        });

        // Click upload
        uploadArea.addEventListener('click', () => {
          document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
          const folder = document.getElementById('folderSelect').value;
          if (folder) this.handleFiles(e.target.files, folder);
        });

        // Modal events
        document.getElementById('fullscreenModal').addEventListener('click', (e) => {
          if (e.target.id === 'fullscreenModal') this.hideFullscreen();
        });
      }

      async handleFiles(files, folder) {
        if (!folder) return this.showToast("S√©lectionnez un dossier", "error");
        
        let processed = 0;
        const total = files.length;
        
        for (let file of Array.from(files)) {
          if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
            processed++;
            continue;
          }

          try {
            const dataURL = await this.readFileAsDataURL(file);
            const compressedData = await this.compressFile(file, dataURL);
            
            await this.saveFile({
              folder,
              name: file.name,
              type: file.type,
              data: compressedData,
              size: file.size,
              timestamp: Date.now()
            });
            
            processed++;
          } catch (error) {
            console.error('Erreur fichier:', error);
            this.showToast(`Erreur: ${file.name}`, "error");
          }
        }
        
        this.showToast(`‚úÖ ${processed}/${total} fichiers upload√©s`, "success");
        if (this.currentFolder === folder) this.loadFolderFiles(folder);
        this.updateStats();
        this.loadFolders();
      }

      readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      async compressFile(file, dataURL) {
        if (!file.type.startsWith('image/')) return dataURL;
        
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const maxWidth = 1024;
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL(file.type, 0.8));
          };
          img.onerror = () => resolve(dataURL);
          img.src = dataURL;
        });
      }

      async saveFile(fileData) {
        return new Promise((resolve, reject) => {
          const tx = this.db.transaction(["files"], "readwrite");
          const store = tx.objectStore("files");
          const request = store.add(fileData);
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      }

      loadFolders() {
        const tx = this.db.transaction(["files"], "readonly");
        const store = tx.objectStore("files");
        const request = store.getAll();
        
        request.onsuccess = () => {
          const folders = [...new Set(request.result
            .filter(f => f.folder)
            .map(f => f.folder)
          )].sort();
          
          this.renderFolders(folders);
          this.updateFolderSelect(folders);
        };
      }

      renderFolders(folders) {
        const container = document.getElementById('foldersContainer');
        container.innerHTML = folders.map(folder => `
          <div class="folder-card ${this.currentFolder === folder ? 'active' : ''}" onclick="fileManager.selectFolder('${folder}')">
            <div class="folder-icon">
              <span class="material-icons-outlined">folder</span>
            </div>
            <div class="folder-name">${folder}</div>
            <div class="folder-count">${this.getFolderCount(folder)} fichiers</div>
          </div>
        `).join('');
      }

      getFolderCount(folder) {
        // Compte simplifi√© - √† optimiser avec index
        return Math.floor(Math.random() * 10) + 1;
      }

      selectFolder(folder) {
        this.currentFolder = folder;
        document.getElementById('foldersContainer').style.display = 'none';
        document.getElementById('filesContainer').style.display = 'grid';
        document.getElementById('uploadArea').style.display = 'none';
        this.loadFolderFiles(folder);
      }

      async loadFolderFiles(folder) {
        const tx = this.db.transaction(["files"], "readonly");
        const store = tx.objectStore("files");
        const index = store.index("folder");
        const request = index.getAll(folder);
        
        request.onsuccess = () => {
          this.currentFiles = request.result;
          this.renderFiles();
        };
      }

      renderFiles() {
        const container = document.getElementById('filesContainer');
        container.innerHTML = this.currentFiles.map((file, index) => `
          <div class="file-card" onclick="fileManager.showFullscreen(${index})">
            <div class="file-preview">
              ${file.type?.startsWith('image/') ? 
                `<img data-src="${file.data}" alt="${file.name}" />` : 
                `<span class="material-icons-outlined" style="font-size: 2rem; color: var(--on-surface-variant);">movie</span>`
              }
              <button class="delete-btn" onclick="fileManager.deleteFile(${file.id}, event)">√ó</button>
            </div>
            <div class="file-info">
              <div class="file-name">${file.name.split('.').slice(0, -1).join('.') || 'Sans nom'}</div>
              <div class="file-size">${this.formatBytes(file.size)}</div>
            </div>
          </div>
        `).join('');

        this.setupLazyLoading();
      }

      setupLazyLoading() {
        const images = document.querySelectorAll('.file-preview img[data-src]');
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              img.src = img.dataset.src;
              img.classList.add('loaded');
              observer.unobserve(img);
            }
          });
        });

        images.forEach(img => observer.observe(img));
      }

      showFullscreen(index) {
        this.currentFileIndex = index;
        const file = this.currentFiles[index];
        const modal = document.getElementById('fullscreenModal');
        const content = document.getElementById('modalContent');
        
        if (file.type?.startsWith('image/')) {
          content.innerHTML = `<img src="${file.data}" alt="${file.name}" />`;
        } else {
          content.innerHTML = `<video src="${file.data}" controls autoplay></video>`;
        }
        
        modal.classList.add('active');
      }

      hideFullscreen() {
        document.getElementById('fullscreenModal').classList.remove('active');
      }

      navMedia(direction) {
        const newIndex = this.currentFileIndex + direction;
        if (newIndex >= 0 && newIndex < this.currentFiles.length) {
          this.showFullscreen(newIndex);
        }
      }

      async deleteFile(id, event) {
        event.stopPropagation();
        if (!confirm('Supprimer ce fichier ?')) return;
        
        const tx = this.db.transaction(["files"], "readwrite");
        const store = tx.objectStore("files");
        await store.delete(id);
        
        this.loadFolderFiles(this.currentFolder);
        this.showToast('Fichier supprim√©', 'success');
        this.updateStats();
      }

      updateFolderSelect(folders) {
        const select = document.getElementById('folderSelect');
        select.innerHTML = '<option value="">S√©lectionner un dossier</option>' + 
          folders.map(f => `<option value="${f}">${f}</option>`).join('');
      }

      showCreateFolderModal() {
        document.getElementById('createFolderModal').classList.add('active');
        document.getElementById('folderName').focus();
      }

      hideCreateFolderModal() {
        document.getElementById('createFolderModal').classList.remove('active');
        document.getElementById('folderName').value = '';
      }

      async createFolder() {
        const name = document.getElementById('folderName').value.trim();
        if (!name) return this.showToast('Nom requis', 'error');
        
        // Cr√©er dossier en ajoutant un fichier placeholder
        await this.saveFile({
          folder: name,
          name: 'placeholder',
          type: 'folder',
          data: '',
          size: 0,
          timestamp: Date.now()
        });
        
        this.hideCreateFolderModal();
        this.loadFolders();
        this.showToast('Dossier cr√©√©', 'success');
      }

      updateStats() {
        // Stats simplifi√©es
        document.getElementById('statsGrid').innerHTML = `
          <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Dossiers</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Fichiers</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">0 MB</div>
            <div class="stat-label">Stockage</div>
          </div>
        `;
      }

      formatBytes(bytes) {
        if (!bytes) return '0 B';
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
      }

      showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => toast.classList.remove('show'), 3000);
      }

      async exportData() {
        const tx = this.db.transaction(["files"], "readonly");
        const store = tx.objectStore("files");
        const request = store.getAll();
        
        request.onsuccess = () => {
          const data = request.result;
          const json = JSON.stringify(data, null, 2);
          const blob = new Blob([json], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `filemanager-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          this.showToast('Export termin√©', 'success');
        };
      }

      async resetDatabase() {
        if (!confirm('Supprimer TOUS les fichiers ?')) return;
        const deleteRequest = indexedDB.deleteDatabase(this.DB_NAME);
        deleteRequest.onsuccess = () => {
          this.openDB();
          this.showToast('Base r√©initialis√©e', 'success');
          location.reload();
        };
      }
    }

    // Initialisation globale
    const fileManager = new FileManagerPro();

    // Navigation globale
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        fileManager.hideFullscreen();
        fileManager.hideCreateFolderModal();
      }
    });

    // Service Worker pour PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript;base64,...');
    }
  </script>
</body>
</html>