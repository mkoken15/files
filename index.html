<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestionnaire de Fichiers Local (IndexedDB)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f5f7fa;
      padding: 20px;
      margin: 0;
      color: #333;
    }
    h1, h2 {
      color: #1a3c34;
      margin: 0 0 10px;
    }
    .section {
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      transition: transform 0.2s ease;
    }
    .section:hover {
      transform: translateY(-2px);
    }
    input, select, button {
      padding: 10px;
      margin: 8px 4px;
      border-radius: 8px;
      border: 1px solid #d0d7de;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #1a3c34;
      box-shadow: 0 0 5px rgba(26, 60, 52, 0.3);
    }
    button {
      background-color: #1a3c34;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    button:hover {
      background-color: #2e6b5e;
      transform: translateY(-1px);
    }
    button:active {
      transform: translateY(0);
    }
    .folder-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    .folder-item {
      background: #e8ecef;
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .folder-item:hover {
      background-color: #d0d7de;
      transform: translateY(-2px);
    }
    .folder-item.active {
      background-color: #1a3c34;
      color: white;
    }
    .preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }
    .preview img, .preview canvas, .preview .video-placeholder {
      width: 100%;
      max-height: 150px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .preview .video-placeholder {
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1rem;
    }
    .preview img:hover, .preview canvas:hover, .preview .video-placeholder:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .file-actions button {
      background-color: #d32f2f;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .file-actions button:hover {
      background-color: #b71c1c;
    }
    #fullscreenViewer {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: pointer;
    }
    #fullscreenViewer img, #fullscreenViewer .video-player {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
    }
    .nav-arrows {
      display: none; /* Flèches invisibles */
    }
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: none;
      z-index: 10000;
    }
    .video-player {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .video-player video {
      width: 100%;
      max-height: 80vh;
      border-radius: 10px;
    }
    .video-controls {
      position: absolute;
      bottom: 10px;
      width: 100%;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
    }
    .video-controls button {
      background: none;
      color: white;
      font-size: 1.2rem;
      padding: 5px;
    }
    .video-controls input[type="range"] {
      width: 100%;
      max-width: 200px;
    }
    .video-controls select {
      background: #1a3c34;
      color: white;
      border: none;
    }
    @media (max-width: 600px) {
      .folder-list {
        grid-template-columns: 1fr;
      }
      .preview {
        grid-template-columns: 1fr;
      }
      .preview img, .preview canvas, .preview .video-placeholder {
        max-height: 200px;
      }
      input, select, button {
        width: 100%;
        padding: 12px;
        font-size: 1.1rem;
      }
      h1, h2 {
        font-size: 1.4rem;
      }
      .folder-item {
        padding: 12px;
      }
      .video-controls {
        flex-wrap: wrap;
      }
      .video-controls input[type="range"] {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1><span class="material-icons">folder</span> Gestionnaire de Fichiers Local</h1>
  <div class="section">
    <h2>Créer un dossier</h2>
    <input type="text" id="folderName" placeholder="Entrez le nom du dossier" />
    <button onclick="createFolder()"><span class="material-icons">create_new_folder</span> Créer</button>
  </div>
  <div class="section">
    <h2>Ajouter des fichiers</h2>
    <select id="folderSelect">
      <option disabled selected>-- Choisir un dossier --</option>
    </select>
    <input type="file" id="fileInput" multiple accept="image/*,video/*" />
    <label for="sortSelect">Trier :</label>
    <select id="sortSelect" onchange="loadFolders()">
      <option value="alpha">Ordre alphabétique</option>
      <option value="recent">Récent</option>
    </select>
    <button onclick="addFiles()"><span class="material-icons">upload_file</span> Ajouter</button>
    <button onclick="exportData()"><span class="material-icons">download</span> Exporter</button>
    <input type="file" id="importInput" accept=".json" style="display: none;" />
    <button onclick="document.getElementById('importInput').click()"><span class="material-icons">upload</span> Importer</button>
  </div>
  <div class="section">
    <h2>Dossiers</h2>
    <button id="backButton" style="display: none;" onclick="goBack()"><span class="material-icons">arrow_back</span> Retour</button>
    <div id="foldersContainer" class="folder-list"></div>
    <div id="filesContainer" class="preview"></div>
  </div>
  <div id="fullscreenViewer"></div>
  <div id="loading" class="loading">Chargement...</div>
  <script>
    const DB_NAME = "FileManagerDB";
    const DB_VERSION = 1;
    const STORE_NAME = "files";
    let db;
    let currentFolder = null;
    let currentFiles = [];
    let currentFileIndex = -1;

    function openDB() {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onerror = () => alert("Erreur d'accès à IndexedDB");
      request.onupgradeneeded = (event) => {
        db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
        }
      };
      request.onsuccess = (event) => {
        db = event.target.result;
        loadFolders();
      };
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function saveFile(folder, file, dataURL) {
      showLoading(true);
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      const fileRecord = { folder, name: file.name, type: file.type, data: dataURL };
      store.add(fileRecord).onsuccess = () => {
        loadFolders();
        showLoading(false);
        alert("Fichier ajouté avec succès !");
      };
    }

    function loadFolders() {
      showLoading(true);
      const tx = db.transaction(STORE_NAME, "readonly");
      const store = tx.objectStore(STORE_NAME);
      const request = store.getAll();
      request.onsuccess = () => {
        const data = request.result.filter(file => file.folder && file.name && file.data);
        const foldersMap = {};
        data.forEach(file => {
          if (!foldersMap[file.folder]) foldersMap[file.folder] = [];
          foldersMap[file.folder].push(file);
        });
        const sortMethod = document.getElementById('sortSelect').value;
        renderFolders(foldersMap, sortMethod);
        updateFolderSelect(Object.keys(foldersMap));
        if (currentFolder) showFolderFiles(currentFolder, sortMethod);
        showLoading(false);
        if (Object.keys(foldersMap).length === 0) {
          document.getElementById('foldersContainer').innerHTML = "<p>Aucun dossier trouvé. Créez un dossier pour commencer !</p>";
        }
      };
      request.onerror = () => {
        showLoading(false);
        alert("Erreur lors du chargement des dossiers");
      };
    }

    function renderFolders(foldersMap, sortMethod) {
      let folders = Object.keys(foldersMap);
      if (sortMethod === 'recent') {
        folders.sort((a, b) => {
          const latestA = Math.max(...foldersMap[a].map(f => f.id));
          const latestB = Math.max(...foldersMap[b].map(f => f.id));
          return latestB - latestA;
        });
      } else {
        folders.sort((a, b) => a.localeCompare(b, ['fr', 'tr'], { sensitivity: 'accent', ignorePunctuation: true }));
      }
      const container = document.getElementById("foldersContainer");
      container.innerHTML = "";
      folders.forEach(folder => {
        const div = document.createElement("div");
        div.className = `folder-item ${folder === currentFolder ? 'active' : ''}`;
        div.innerHTML = `<span class="material-icons">folder</span> ${folder}`;
        div.onclick = () => {
          currentFolder = folder;
          showFolderFiles(folder, sortMethod);
          document.getElementById('backButton').style.display = 'inline-flex';
        };
        container.appendChild(div);
      });
      if (!currentFolder) {
        document.getElementById("filesContainer").innerHTML = "";
        document.getElementById('backButton').style.display = 'none';
      }
    }

    function showFolderFiles(folder, sortMethod) {
      showLoading(true);
      const tx = db.transaction(STORE_NAME, "readonly");
      const store = tx.objectStore(STORE_NAME);
      const request = store.getAll();
      request.onsuccess = () => {
        currentFiles = request.result.filter(file => file.folder === folder);
        if (sortMethod === 'recent') {
          currentFiles.sort((a, b) => b.id - a.id);
        } else {
          currentFiles.sort((a, b) => a.name.localeCompare(b.name, ['fr', 'tr'], { sensitivity: 'accent', ignorePunctuation: true }));
        }
        renderFiles(currentFiles, folder);
        loadFolders();
        showLoading(false);
      };
    }

    function generateVideoThumbnail(video, callback) {
      video.onloadedmetadata = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        video.currentTime = 1;
        video.onseeked = () => {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          callback(canvas);
        };
        video.onerror = () => callback(null);
      };
      video.onerror = () => callback(null);
    }

    function renderFiles(files, folder) {
      const container = document.getElementById("filesContainer");
      container.innerHTML = `<h3><span class="material-icons">folder_open</span> Fichiers dans ${folder}</h3>`;
      const preview = document.createElement("div");
      preview.className = "preview";
      if (files.length === 0) {
        preview.innerHTML = "<p>Aucun fichier dans ce dossier. Ajoutez des images ou vidéos !</p>";
      }
      files.forEach(file => {
        const wrapper = document.createElement('div');
        wrapper.style.display = 'inline-block';
        let element;
        if (file.type.startsWith('image')) {
          element = document.createElement('img');
          element.src = file.data;
          element.onerror = () => {
            element.replaceWith(document.createElement('p').appendChild(document.createTextNode(`Erreur: ${file.name}`)).parentElement);
          };
          element.onclick = () => showFullscreen(file, files.indexOf(file));
          wrapper.appendChild(element);
        } else if (file.type.startsWith('video')) {
          const video = document.createElement('video');
          video.src = file.data;
          generateVideoThumbnail(video, (canvas) => {
            if (canvas) {
              element = canvas;
            } else {
              element = document.createElement('div');
              element.className = 'video-placeholder';
              element.innerHTML = `<span class="material-icons">movie</span> ${file.name}`;
            }
            element.onclick = () => showFullscreen(file, files.indexOf(file));
            wrapper.appendChild(element);
          });
        }
        if (element) {
          const delBtn = document.createElement('button');
          delBtn.innerHTML = '<span class="material-icons">delete</span> Supprimer';
          delBtn.className = 'file-actions-btn';
          delBtn.onclick = (e) => {
            e.stopPropagation();
            if (confirm("Voulez-vous vraiment supprimer ce fichier ?")) {
              deleteFile(file.id);
            }
          };
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'file-actions';
          actionsDiv.appendChild(delBtn);
          wrapper.appendChild(actionsDiv);
          preview.appendChild(wrapper);
        }
      });
      container.appendChild(preview);
    }

    function updateFolderSelect(folders) {
      const sortMethod = document.getElementById('sortSelect').value;
      if (sortMethod === 'recent') {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const request = store.getAll();
        request.onsuccess = () => {
          const data = request.result;
          const foldersMap = {};
          data.forEach(file => {
            if (!foldersMap[file.folder]) foldersMap[file.folder] = [];
            foldersMap[file.folder].push(file);
          });
          folders = Object.keys(foldersMap).sort((a, b) => {
            const latestA = Math.max(...foldersMap[a].map(f => f.id));
            const latestB = Math.max(...foldersMap[b].map(f => f.id));
            return latestB - latestA;
          });
          const select = document.getElementById("folderSelect");
          const currentValue = select.value;
          select.innerHTML = '<option disabled selected>-- Choisir un dossier --</option>';
          folders.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f;
            opt.textContent = f;
            select.appendChild(opt);
          });
          if (folders.includes(currentValue)) select.value = currentValue;
        };
      } else {
        folders.sort((a, b) => a.localeCompare(b, ['fr', 'tr'], { sensitivity: 'accent', ignorePunctuation: true }));
        const select = document.getElementById("folderSelect");
        const currentValue = select.value;
        select.innerHTML = '<option disabled selected>-- Choisir un dossier --</option>';
        folders.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f;
          opt.textContent = f;
          select.appendChild(opt);
        });
        if (folders.includes(currentValue)) select.value = currentValue;
      }
    }

    function createFolder() {
      const name = document.getElementById('folderName').value.trim();
      if (!name) {
        alert("Nom du dossier invalide.");
        return;
      }
      const select = document.getElementById('folderSelect');
      const exists = [...select.options].some(o => o.value.toLowerCase() === name.toLowerCase());
      if (exists) {
        alert("Ce dossier existe déjà !");
        return;
      }
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      const fileRecord = { folder: name, name: `placeholder_${Date.now()}`, type: "text/plain", data: "data:text/plain;base64," };
      store.add(fileRecord).onsuccess = () => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
        select.value = name;
        loadFolders();
        document.getElementById('folderName').value = '';
        alert("Dossier créé avec succès !");
      };
    }

    function addFiles() {
      const folderName = document.getElementById('folderSelect').value;
      const files = document.getElementById('fileInput').files;
      if (!folderName || files.length === 0) {
        alert("Sélectionne un dossier et des fichiers");
        return;
      }
      showLoading(true);
      let processed = 0;
      for (let file of files) {
        if (!file.type.startsWith('image') && !file.type.startsWith('video')) {
          processed++;
          if (processed === files.length) showLoading(false);
          continue;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          saveFile(folderName, file, e.target.result);
          processed++;
          if (processed === files.length) showLoading(false);
        };
        reader.readAsDataURL(file);
      }
      document.getElementById('fileInput').value = '';
    }

    function deleteFile(id) {
      showLoading(true);
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      store.delete(id).onsuccess = () => {
        const sortMethod = document.getElementById('sortSelect').value;
        if (currentFolder) showFolderFiles(currentFolder, sortMethod);
        loadFolders();
        showLoading(false);
        alert("Fichier supprimé avec succès !");
      };
    }

    function exportData() {
      showLoading(true);
      const tx = db.transaction(STORE_NAME, "readonly");
      const store = tx.objectStore(STORE_NAME);
      const request = store.getAll();
      request.onsuccess = () => {
        const data = request.result.filter(file => !file.name.startsWith('placeholder_'));
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `filemanager_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showLoading(false);
        alert("Données exportées avec succès !");
      };
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file || !file.name.endsWith('.json')) {
        alert("Veuillez sélectionner un fichier JSON valide.");
        return;
      }
      showLoading(true);
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data)) throw new Error("Format JSON invalide");
          const tx = db.transaction(STORE_NAME, "readwrite");
          const store = tx.objectStore(STORE_NAME);
          let processed = 0;
          data.forEach(record => {
            if (record.folder && record.name && record.type && record.data) {
              store.put(record).onsuccess = () => {
                processed++;
                if (processed === data.length) {
                  loadFolders();
                  showLoading(false);
                  alert("Données importées avec succès !");
                }
              };
            } else {
              processed++;
              if (processed === data.length) {
                loadFolders();
                showLoading(false);
                alert("Données importées, mais certaines entrées étaient invalides.");
              }
            }
          });
        } catch (err) {
          showLoading(false);
          alert("Erreur lors de l'importation : " + err.message);
        }
      };
      reader.readAsText(file);
      document.getElementById('importInput').value = '';
    }

    function showFullscreen(file, index) {
      currentFileIndex = index;
      const overlay = document.getElementById('fullscreenViewer');
      overlay.innerHTML = '<div class="nav-arrows"><button id="prevMedia">&larr;</button><button id="nextMedia">&rarr;</button></div>';
      let element;
      if (file.type.startsWith('image')) {
        element = document.createElement('img');
        element.src = file.data;
        element.onerror = () => alert(`Erreur de chargement de l'image: ${file.name}`);
      } else if (file.type.startsWith('video')) {
        const player = document.createElement('div');
        player.className = 'video-player';
        const video = document.createElement('video');
        video.src = file.data;
        video.setAttribute('playsinline', '');
        video.addEventListener('error', (e) => {
          console.error(`Erreur de chargement de la vidéo en plein écran ${file.name}:`, e);
          alert(`Erreur de chargement de la vidéo: ${file.name}`);
        });
        player.appendChild(video);
        const controls = document.createElement('div');
        controls.className = 'video-controls';
        controls.innerHTML = `
          <button onclick="this.parentElement.parentElement.querySelector('video').paused ? this.parentElement.parentElement.querySelector('video').play() : this.parentElement.parentElement.querySelector('video').pause(); this.querySelector('span').textContent = this.parentElement.parentElement.querySelector('video').paused ? 'play_arrow' : 'pause';">
            <span class="material-icons">play_arrow</span>
          </button>
          <input type="range" min="0" max="100" value="0" class="progress">
          <input type="range" min="0" max="1" step="0.1" value="1" class="volume">
          <select class="speed">
            <option value="0.5">0.5x</option>
            <option value="1" selected>1x</option>
            <option value="1.5">1.5x</option>
            <option value="2">2x</option>
          </select>
          <button onclick="if (document.fullscreenElement) document.exitFullscreen(); else this.parentElement.parentElement.querySelector('video').requestFullscreen();">
            <span class="material-icons">fullscreen</span>
          </button>
        `;
        player.appendChild(controls);
        video.addEventListener('timeupdate', () => {
          const progress = controls.querySelector('.progress');
          progress.value = (video.currentTime / video.duration) * 100;
        });
        controls.querySelector('.progress').addEventListener('input', (e) => {
          video.currentTime = (e.target.value / 100) * video.duration;
        });
        controls.querySelector('.volume').addEventListener('input', (e) => {
          video.volume = e.target.value;
        });
        controls.querySelector('.speed').addEventListener('change', (e) => {
          video.playbackRate = parseFloat(e.target.value);
        });
        element = player;
      }
      overlay.appendChild(element);
      overlay.style.display = 'flex';
      document.getElementById('prevMedia').style.display = 'none';
      document.getElementById('nextMedia').style.display = 'none';
    }

    function handleNavigation(event) {
      if (event.target.id === 'fullscreenViewer' || event.target.tagName === 'IMG' || event.target.tagName === 'VIDEO') {
        const rect = event.target.getBoundingClientRect();
        const clickX = event.clientX - rect.left;
        const width = rect.width;
        if (clickX < width / 2 && currentFileIndex > 0) {
          showFullscreen(currentFiles[currentFileIndex - 1], currentFileIndex - 1);
        } else if (clickX >= width / 2 && currentFileIndex < currentFiles.length - 1) {
          showFullscreen(currentFiles[currentFileIndex + 1], currentFileIndex + 1);
        }
      }
    }

    function hideFullscreen() {
      const overlay = document.getElementById('fullscreenViewer');
      overlay.style.display = 'none';
      overlay.innerHTML = '<div class="nav-arrows"><button id="prevMedia" style="display: none;">&larr;</button><button id="nextMedia" style="display: none;">&rarr;</button></div>';
      currentFileIndex = -1;
    }

    function goBack() {
      currentFolder = null;
      loadFolders();
    }

    document.getElementById('fullscreenViewer').addEventListener('click', handleNavigation);
    document.getElementById('importInput').addEventListener('change', importData);

    window.onload = openDB;
  </script>
</body>
</html>