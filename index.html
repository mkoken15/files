<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìÅ FileManager PRO - FONCTIONNEL</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5; color: #333; line-height: 1.6;
    }
    .header { 
      background: #2196F3; color: white; padding: 15px 20px; 
      display: flex; justify-content: space-between; align-items: center;
    }
    .header h1 { font-size: 1.5rem; }
    .btn { 
      background: #4CAF50; color: white; border: none; padding: 10px 20px; 
      border-radius: 5px; cursor: pointer; margin: 0 5px;
    }
    .btn:hover { background: #45a049; }
    .btn-danger { background: #f44336; }
    .btn-danger:hover { background: #da190b; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .upload-area { 
      border: 2px dashed #ccc; border-radius: 10px; padding: 40px; 
      text-align: center; margin: 20px 0; cursor: pointer;
      transition: border-color 0.3s;
    }
    .upload-area:hover, .upload-area.dragover { 
      border-color: #2196F3; background: #e3f2fd;
    }
    .folder-grid, .file-grid { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
      gap: 20px; margin: 20px 0;
    }
    .folder-card, .file-card { 
      background: white; border-radius: 10px; padding: 15px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer;
      transition: transform 0.2s;
    }
    .folder-card:hover, .file-card:hover { transform: translateY(-2px); }
    .folder-icon { font-size: 3rem; color: #FF9800; }
    .file-preview { 
      width: 100%; height: 150px; background: #f0f0f0; 
      border-radius: 5px; display: flex; align-items: center; justify-content: center;
      margin-bottom: 10px; overflow: hidden;
    }
    .file-preview img, .file-preview video { 
      width: 100%; height: 100%; object-fit: cover;
    }
    .file-preview.loading::after { 
      content: "‚è≥"; font-size: 2rem; color: #999;
    }
    .modal { 
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content { max-width: 90%; max-height: 90%; }
    .modal-content img, .modal-content video { max-width: 100%; max-height: 100%; }
    .close-modal { 
      position: absolute; top: 20px; right: 30px; color: white; font-size: 30px; 
      cursor: pointer;
    }
    #toast { 
      position: fixed; bottom: 20px; right: 20px; background: #333; 
      color: white; padding: 15px; border-radius: 5px; display: none;
    }
    select, input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 5px; }
  </style>
</head>
<body>
  <div class="header">
    <h1><span class="material-icons">folder_special</span> FileManager PRO</h1>
    <div>
      <button class="btn" onclick="createFolder()">üìÅ Nouveau dossier</button>
      <button class="btn" onclick="exportData()">üì• Exporter</button>
      <button class="btn-danger" onclick="resetDB()">üóëÔ∏è Reset</button>
    </div>
  </div>

  <div class="container">
    <div class="upload-area" id="uploadArea">
      <input type="file" id="fileInput" multiple accept="image/*,video/*" style="display:none;">
      <p><span class="material-icons" style="font-size:4rem;">cloud_upload</span></p>
      <p>Glissez vos fichiers ici ou cliquez</p>
      <select id="folderSelect">
        <option value="">Choisir un dossier</option>
      </select>
    </div>

    <div class="folder-grid" id="folders"></div>
    <div class="file-grid" id="files" style="display:none;"></div>
  </div>

  <div id="modal" class="modal">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <div class="modal-content" id="modalContent"></div>
  </div>

  <div id="toast"></div>

  <script>
    class FileManager {
      constructor() {
        this.db = null;
        this.DB_NAME = "FileManagerPro";
        this.currentFolder = null;
        this.init();
      }

      init() {
        this.openDB();
        this.setupEvents();
      }

      openDB() {
        const request = indexedDB.open(this.DB_NAME, 3);
        
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('files')) {
            const store = db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
            store.createIndex('folder', 'folder');
            store.createIndex('name', 'name');
            store.createIndex('timestamp', 'timestamp');
          }
        };

        request.onsuccess = (e) => {
          this.db = e.target.result;
          this.loadFolders();
          this.updateFolderSelect();
          showToast('‚úÖ Pr√™t !');
        };

        request.onerror = () => showToast('‚ùå Erreur DB', true);
      }

      setupEvents() {
        const uploadArea = document.getElementById('uploadArea');
        
        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
          uploadArea.addEventListener(event, e => {
            e.preventDefault();
            uploadArea.classList.toggle('dragover', event === 'dragenter' || event === 'dragover');
            if (event === 'drop') {
              const folder = document.getElementById('folderSelect').value;
              if (folder) this.uploadFiles(e.dataTransfer.files, folder);
            }
          });
        });

        uploadArea.addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('fileInput').addEventListener('change', e => {
          const folder = document.getElementById('folderSelect').value;
          if (folder) this.uploadFiles(e.target.files, folder);
        });
      }

      async uploadFiles(files, folder) {
        if (!folder) return showToast('Choisissez un dossier !', true);
        
        let success = 0;
        for (let file of Array.from(files)) {
          try {
            const dataUrl = await this.fileToDataURL(file);
            const compressed = await this.compressImageIfNeeded(file, dataUrl);
            
            await this.saveFile({
              folder,
              name: file.name,
              type: file.type,
              data: compressed,
              size: file.size,
              timestamp: Date.now()
            });
            success++;
          } catch (e) {
            console.error(e);
          }
        }
        
        showToast(`‚úÖ ${success} fichier(s) upload√©(s)`);
        if (this.currentFolder === folder) this.loadFiles(folder);
        this.loadFolders();
        this.updateFolderSelect();
      }

      fileToDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      compressImageIfNeeded(file, dataUrl) {
        if (!file.type.startsWith('image/')) return Promise.resolve(dataUrl);
        
        return new Promise(resolve => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const maxSize = 800;
            let { width, height } = img;
            
            if (width > height) {
              if (width > maxSize) {
                height = (height * maxSize) / width;
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = (width * maxSize) / height;
                height = maxSize;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL(file.type, 0.8));
          };
          img.onerror = () => resolve(dataUrl);
          img.src = dataUrl;
        });
      }

      saveFile(fileData) {
        return new Promise((resolve, reject) => {
          const tx = this.db.transaction('files', 'readwrite');
          const store = tx.objectStore('files');
          const req = store.add(fileData);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }

      loadFolders() {
        const tx = this.db.transaction('files', 'readonly');
        const store = tx.objectStore('files');
        const req = store.getAll();
        
        req.onsuccess = () => {
          const folders = [...new Set(req.result
            .filter(f => f.folder && f.folder !== 'undefined')
            .map(f => f.folder)
          )].sort();
          
          document.getElementById('folders').innerHTML = folders.map(folder => {
            const count = req.result.filter(f => f.folder === folder).length;
            return `
              <div class="folder-card" onclick="fileManager.openFolder('${folder}')">
                <div class="folder-icon"><span class="material-icons">folder</span></div>
                <h3>${folder}</h3>
                <p>${count} fichier(s)</p>
              </div>
            `;
          }).join('');
        };
      }

      updateFolderSelect() {
        const tx = this.db.transaction('files', 'readonly');
        const store = tx.objectStore('files');
        const req = store.getAll();
        
        req.onsuccess = () => {
          const folders = [...new Set(req.result
            .filter(f => f.folder && f.folder !== 'undefined')
            .map(f => f.folder)
          )].sort();
          
          const select = document.getElementById('folderSelect');
          select.innerHTML = '<option value="">Choisir un dossier</option>' + 
            folders.map(f => `<option value="${f}">${f}</option>`).join('');
        };
      }

      openFolder(folder) {
        this.currentFolder = folder;
        document.getElementById('folders').style.display = 'none';
        document.getElementById('files').style.display = 'grid';
        document.getElementById('uploadArea').style.display = 'none';
        this.loadFiles(folder);
      }

      loadFiles(folder) {
        const tx = this.db.transaction('files', 'readonly');
        const store = tx.objectStore('files');
        const index = store.index('folder');
        const req = index.getAll(folder);
        
        req.onsuccess = () => {
          const files = req.result.sort((a, b) => b.timestamp - a.timestamp);
          document.getElementById('files').innerHTML = files.map(file => {
            const isImage = file.type?.startsWith('image/');
            return `
              <div class="file-card">
                <div class="file-preview ${isImage ? '' : 'loading'}"
                     onclick="fileManager.openModal('${file.id}')" 
                     style="cursor:pointer;">
                  ${isImage ? `<img src="${file.data}" alt="${file.name}" 
                                onload="this.parentNode.classList.remove('loading')" 
                                onerror="this.parentNode.classList.remove('loading');this.parentNode.innerHTML='<span class=\\'material-icons\\'>error</span>'">` : 
                            `<span class="material-icons" style="font-size:2rem;color:#999;">movie</span>`}
                </div>
                <h4>${file.name}</h4>
                <p>${(file.size / 1024 / 1024).toFixed(1)} MB</p>
                <button class="btn-danger" onclick="fileManager.deleteFile(${file.id}, event)" 
                        style="width:100%;margin-top:10px;">Supprimer</button>
              </div>
            `;
          }).join('');
        };
      }

      openModal(id) {
        const tx = this.db.transaction('files', 'readonly');
        const store = tx.objectStore('files');
        const req = store.get(id);
        
        req.onsuccess = () => {
          const file = req.result;
          const modal = document.getElementById('modal');
          const content = document.getElementById('modalContent');
          
          if (file.type?.startsWith('image/')) {
            content.innerHTML = `<img src="${file.data}" alt="${file.name}">`;
          } else {
            content.innerHTML = `<video src="${file.data}" controls style="max-width:100%;max-height:100%"></video>`;
          }
          
          modal.classList.add('active');
        };
      }

      deleteFile(id, event) {
        event.stopPropagation();
        if (!confirm('Supprimer ce fichier ?')) return;
        
        const tx = this.db.transaction('files', 'readwrite');
        const store = tx.objectStore('files');
        store.delete(id);
        
        showToast('Fichier supprim√©');
        if (this.currentFolder) this.loadFiles(this.currentFolder);
        this.loadFolders();
        this.updateFolderSelect();
      }

      async createFolder() {
        const name = prompt('Nom du dossier :');
        if (!name) return;
        
        await this.saveFile({
          folder: name,
          name: '.dossier',
          type: 'folder',
          data: '',
          size: 0,
          timestamp: Date.now()
        });
        
        this.loadFolders();
        this.updateFolderSelect();
        showToast('Dossier cr√©√©');
      }

      async exportData() {
        const tx = this.db.transaction('files', 'readonly');
        const store = tx.objectStore('files');
        const req = store.getAll();
        
        req.onsuccess = () => {
          const dataStr = JSON.stringify(req.result, null, 2);
          const dataBlob = new Blob([dataStr], {type: 'application/json'});
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          URL.revokeObjectURL(url);
          showToast('Export termin√©');
        };
      }

      async resetDB() {
        if (!confirm('Supprimer TOUS les fichiers ?')) return;
        const delReq = indexedDB.deleteDatabase(this.DB_NAME);
        delReq.onsuccess = () => location.reload();
      }
    }

    function showToast(msg, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.background = isError ? '#f44336' : '#4CAF50';
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    // Back to folders
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeModal();
    });

    const fileManager = new FileManager();
  </script>
</body>
</html>