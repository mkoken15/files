<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestionnaire de Fichiers Local (IndexedDB)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    h1, h2 {
      color: #333;
    }
    .section {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #45a049;
    }
    .folder-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .folder-item {
      background: #e0e0e0;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .folder-item:hover {
      background-color: #d0d0d0;
    }
    .preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .preview img, .preview video {
      width: 100%;
      max-width: 240px;
      max-height: 180px;
      margin: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .preview video {
      object-fit: cover;
      display: block;
    }
    .preview img:hover, .preview video:hover {
      transform: scale(1.05);
    }
    .file-actions button {
      margin-left: 10px;
      background-color: #f44336;
      border: none;
      color: white;
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background-color 0.3s ease;
    }
    .file-actions button:hover {
      background-color: #d32f2f;
    }
    #fullscreenViewer {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: zoom-out;
    }
    #fullscreenViewer img, #fullscreenViewer video {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 10px;
      user-select: none;
      box-shadow: 0 0 20px rgba(255,255,255,0.3);
    }
    @media (max-width: 600px) {
      .preview {
        flex-direction: column;
        gap: 8px;
      }
      .preview img, .preview video {
        max-width: 100%;
        max-height: none;
        margin: 5px 0;
      }
      .preview div {
        width: 100% !important;
        display: block;
      }
      input, select, button {
        width: 100%;
        padding: 12px;
        font-size: 1.1rem;
        margin: 10px 0;
        border-radius: 8px;
      }
      h1, h2 {
        font-size: 1.3rem;
      }
      .folder-item {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <h1>üìÅ Gestionnaire de Fichiers Local</h1>
  <div class="section">
    <h2>Cr√©er un dossier</h2>
    <input type="text" id="folderName" placeholder="Nom du dossier" />
    <button onclick="createFolder()">Cr√©er</button>
  </div>
  <div class="section">
    <h2>Ajouter des fichiers</h2>
    <select id="folderSelect">
      <option disabled selected>-- Choisir un dossier --</option>
    </select>
    <input type="file" id="fileInput" multiple accept="image/*,video/*" />
    <label for="sortSelect">Trier :</label>
    <select id="sortSelect" onchange="loadFolders()">
      <option value="alpha">Ordre alphab√©tique</option>
      <option value="recent">R√©cent</option>
    </select>
    <button onclick="addFiles()">Ajouter</button>
  </div>
  <div class="section">
    <h2>Dossiers</h2>
    <div id="foldersContainer" class="folder-list"></div>
    <div id="filesContainer" class="preview"></div>
  </div>
  <div id="fullscreenViewer" onclick="hideFullscreen()"></div>
  <script>
    const DB_NAME = "FileManagerDB";
    const DB_VERSION = 1;
    const STORE_NAME = "files";
    let db;
    let currentFolder = null;

    function openDB() {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onerror = () => alert("Erreur d'acc√®s √† IndexedDB");
      request.onupgradeneeded = (event) => {
        db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
        }
      };
      request.onsuccess = (event) => {
        db = event.target.result;
        loadFolders();
      };
    }

    function saveFile(folder, file, dataURL) {
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      const fileRecord = { folder, name: file.name, type: file.type, data: dataURL };
      store.add(fileRecord).onsuccess = () => loadFolders();
    }

    function loadFolders() {
      const tx = db.transaction(STORE_NAME, "readonly");
      const store = tx.objectStore(STORE_NAME);
      const request = store.getAll();
      request.onsuccess = () => {
        const data = request.result;
        const foldersMap = {};
        data.forEach(file => {
          if (!foldersMap[file.folder]) foldersMap[file.folder] = [];
          foldersMap[file.folder].push(file);
        });
        const sortMethod = document.getElementById('sortSelect').value;
        renderFolders(foldersMap, sortMethod);
        updateFolderSelect(Object.keys(foldersMap));
        if (currentFolder) showFolderFiles(currentFolder, sortMethod); // Refresh current folder view
      };
    }

    function renderFolders(foldersMap, sortMethod) {
      let folders = Object.keys(foldersMap);
      if (sortMethod === 'recent') {
        folders.sort((a, b) => {
          const latestA = Math.max(...foldersMap[a].map(f => f.id));
          const latestB = Math.max(...foldersMap[b].map(f => f.id));
          return latestB - latestA;
        });
      } else {
        folders.sort((a, b) => a.localeCompare(b, ['fr', 'tr'], { sensitivity: 'accent', ignorePunctuation: true }));
      }
      const container = document.getElementById("foldersContainer");
      container.innerHTML = "";
      folders.forEach(folder => {
        const div = document.createElement("div");
        div.className = "folder-item";
        div.textContent = folder;
        div.onclick = () => {
          currentFolder = folder;
          showFolderFiles(folder, sortMethod);
        };
        container.appendChild(div);
      });
      if (!currentFolder) document.getElementById("filesContainer").innerHTML = ""; // Clear files if no folder selected
    }

    function showFolderFiles(folder, sortMethod) {
      const tx = db.transaction(STORE_NAME, "readonly");
      const store = tx.objectStore(STORE_NAME);
      const request = store.getAll();
      request.onsuccess = () => {
        let files = request.result.filter(file => file.folder === folder);
        if (sortMethod === 'recent') {
          files.sort((a, b) => b.id - a.id);
        } else {
          files.sort((a, b) => a.name.localeCompare(b.name, ['fr', 'tr'], { sensitivity: 'accent', ignorePunctuation: true }));
        }
        renderFiles(files, folder);
      };
    }

    function renderFiles(files, folder) {
      const container = document.getElementById("filesContainer");
      container.innerHTML = `<h3>Fichiers dans ${folder}</h3>`;
      const preview = document.createElement("div");
      preview.className = "preview";
      files.forEach(file => {
        let element;
        if (file.type.startsWith('image')) {
          element = document.createElement('img');
          element.src = file.data;
        } else if (file.type.startsWith('video')) {
          element = document.createElement('video');
          element.src = file.data;
          element.controls = true;
        }
        if (element) {
          element.onclick = () => showFullscreen(file);
          const wrapper = document.createElement('div');
          wrapper.style.display = 'inline-block';
          wrapper.appendChild(element);
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Supprimer';
          delBtn.className = 'file-actions-btn';
          delBtn.onclick = (e) => {
            e.stopPropagation();
            deleteFile(file.id);
          };
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'file-actions';
          actionsDiv.appendChild(delBtn);
          wrapper.appendChild(actionsDiv);
          preview.appendChild(wrapper);
        }
      });
      container.appendChild(preview);
    }

    function updateFolderSelect(folders) {
      const sortMethod = document.getElementById('sortSelect').value;
      if (sortMethod === 'recent') {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const request = store.getAll();
        request.onsuccess = () => {
          const data = request.result;
          const foldersMap = {};
          data.forEach(file => {
            if (!foldersMap[file.folder]) foldersMap[file.folder] = [];
            foldersMap[file.folder].push(file);
          });
          folders = Object.keys(foldersMap).sort((a, b) => {
            const latestA = Math.max(...foldersMap[a].map(f => f.id));
            const latestB = Math.max(...foldersMap[b].map(f => f.id));
            return latestB - latestA;
          });
          const select = document.getElementById("folderSelect");
          const currentValue = select.value;
          select.innerHTML = '<option disabled>-- Choisir un dossier --</option>';
          folders.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f;
            opt.textContent = f;
            select.appendChild(opt);
          });
          if (folders.includes(currentValue)) select.value = currentValue;
        };
      } else {
        folders.sort((a, b) => a.localeCompare(b, ['fr', 'tr'], { sensitivity: 'accent', ignorePunctuation: true }));
        const select = document.getElementById("folderSelect");
        const currentValue = select.value;
        select.innerHTML = '<option disabled>-- Choisir un dossier --</option>';
        folders.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f;
          opt.textContent = f;
          select.appendChild(opt);
        });
        if (folders.includes(currentValue)) select.value = currentValue;
      }
    }

    function createFolder() {
      const name = document.getElementById('folderName').value.trim();
      if (!name) return alert("Nom du dossier invalide.");
      const select = document.getElementById('folderSelect');
      const exists = [...select.options].some(o => o.value === name);
      if (!exists) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
        select.value = name;
        loadFolders();
      }
      document.getElementById('folderName').value = '';
    }

    function addFiles() {
      const folderName = document.getElementById('folderSelect').value;
      const files = document.getElementById('fileInput').files;
      if (!folderName || files.length === 0) return alert("S√©lectionne un dossier et des fichiers");
      for (let file of files) {
        if (!file.type.startsWith('image') && !file.type.startsWith('video')) continue;
        const reader = new FileReader();
        reader.onload = function(e) {
          saveFile(folderName, file, e.target.result);
        };
        reader.readAsDataURL(file);
      }
      document.getElementById('fileInput').value = '';
    }

    function deleteFile(id) {
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      store.delete(id).onsuccess = () => {
        const sortMethod = document.getElementById('sortSelect').value;
        if (currentFolder) showFolderFiles(currentFolder, sortMethod);
        loadFolders();
      };
    }

    function showFullscreen(file) {
      const overlay = document.getElementById('fullscreenViewer');
      overlay.innerHTML = '';
      let element;
      if (file.type.startsWith('image')) {
        element = document.createElement('img');
        element.src = file.data;
      } else if (file.type.startsWith('video')) {
        element = document.createElement('video');
        element.src = file.data;
        element.controls = true;
        element.autoplay = true;
      }
      overlay.appendChild(element);
      overlay.style.display = 'flex';
    }

    function hideFullscreen() {
      const overlay = document.getElementById('fullscreenViewer');
      overlay.style.display = 'none';
      overlay.innerHTML = '';
    }

    document.getElementById('fullscreenViewer').addEventListener('click', (e) => {
      if (e.target.id === 'fullscreenViewer') hideFullscreen();
    });

    window.onload = openDB;
  </script>
</body>
</html>